<%- include('../partials/header', { title }) %>
<section class="space-y-8">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase tracking-wide text-emerald-300">Admin</p>
      <h1 class="text-2xl font-semibold">Dashboard</h1>
    </div>
    <div class="text-sm text-slate-300">Signed in as <%= user?.email %></div>
  </div>

  <div class="grid md:grid-cols-4 gap-4">
    <div class="bg-slate-900 border border-slate-800 rounded p-3">
      <p class="text-xs text-slate-400">Movies</p>
      <p class="text-2xl font-semibold text-emerald-200"><%= movies.length %></p>
    </div>
    <div class="bg-slate-900 border border-slate-800 rounded p-3">
      <p class="text-xs text-slate-400">Users</p>
      <p class="text-2xl font-semibold text-emerald-200"><%= users?.length || 0 %></p>
    </div>
    <div class="bg-slate-900 border border-slate-800 rounded p-3">
      <p class="text-xs text-slate-400">Reviews</p>
      <p class="text-2xl font-semibold text-emerald-200"><%= totalReviewCount || 0 %></p>
    </div>
    <div class="bg-slate-900 border border-slate-800 rounded p-3">
      <p class="text-xs text-slate-400">Avg rating</p>
      <p class="text-2xl font-semibold text-emerald-200"><%= overallAvgRating || 0 %> / 5</p>
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-6">
    <div class="space-y-4 bg-slate-900 border border-slate-800 p-4 rounded-lg">
      <h2 class="text-lg font-semibold">Add Movie</h2>
      <form id="movieForm" class="space-y-3">
        <input name="title" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Title" required />
        <textarea name="description" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Description"></textarea>
        <input name="posterUrl" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Poster URL" />
        <input name="durationMins" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Duration (mins)" />
        <input name="genres" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Genres comma separated" />
        <select name="status" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2">
          <option value="now_showing">Now Showing</option>
          <option value="coming_soon">Coming Soon</option>
        </select>
        <div id="movieMsg" class="text-sm text-emerald-300 hidden"></div>
        <button class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold py-2 rounded" type="submit">Create</button>
      </form>
    </div>

    <div class="space-y-4 bg-slate-900 border border-slate-800 p-4 rounded-lg">
      <h2 class="text-lg font-semibold">Add Screening</h2>
      <form id="screeningForm" class="space-y-3">
        <label class="block text-sm text-slate-300">Movie</label>
        <select name="movie" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" required>
          <option value="">Select movie</option>
          <% movies.forEach(m => { %>
            <option value="<%= m._id %>"><%= m.title %></option>
          <% }) %>
        </select>
        <label class="block text-sm text-slate-300">Theatre</label>
        <select name="theatre" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" required>
          <option value="">Select theatre</option>
          <% theatres.forEach(t => { %>
            <option value="<%= t._id %>"><%= t.name %> - <%= t.location %></option>
          <% }) %>
        </select>
        <input name="startTime" type="datetime-local" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" required />
        <input name="price" type="number" step="0.01" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Price" required />
        <input name="seatsAvailable" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Seats available" required />
        <input name="screen" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Screen number (optional)" />
        <div id="screeningMsg" class="text-sm text-emerald-300 hidden"></div>
        <button class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold py-2 rounded" type="submit">Create</button>
      </form>
    </div>

    <div class="space-y-4 bg-slate-900 border border-slate-800 p-4 rounded-lg">
      <h2 class="text-lg font-semibold">Add Theatre</h2>
      <form id="theatreForm" class="space-y-3">
        <input name="name" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Theatre name" required />
        <input name="location" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Location" required />
        <input name="screens" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Number of screens (optional)" />
        <div id="theatreMsg" class="text-sm text-emerald-300 hidden"></div>
        <button class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold py-2 rounded" type="submit">Create</button>
      </form>
    </div>
  </div>

  <div class="space-y-3">
    <h2 class="text-lg font-semibold">Existing Movies</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <% if (movies.length === 0) { %>
        <p class="text-slate-400">No movies yet.</p>
      <% } %>
      <% movies.forEach(m => { %>
        <article class="bg-slate-900 border border-slate-800 rounded p-3 space-y-2">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold"><%= m.title %></h3>
            <span class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-300"><%= m.status %></span>
          </div>
          <p class="text-sm text-slate-300 line-clamp-3"><%= m.description || 'No description' %></p>
          <p class="text-xs text-slate-400">Genres: <%= (m.genres || []).join(', ') %></p>
          <p class="text-xs text-slate-400">Duration: <%= m.durationMins || 'TBD' %> mins</p>
          <div class="flex space-x-2 pt-2">
            <button class="px-3 py-1 text-xs rounded border border-slate-700 hover:border-emerald-400 hover:text-emerald-300"
              data-id="<%= m._id %>"
              data-title="<%- (m.title || '').replace(/"/g, '&quot;') %>"
              data-status="<%- (m.status || '').replace(/"/g, '&quot;') %>"
              data-duration="<%= m.durationMins || 0 %>"
              onclick="editMovie(this.dataset.id, this.dataset.title, this.dataset.status, Number(this.dataset.duration))">
              Edit
            </button>
            <button class="px-3 py-1 text-xs rounded border border-rose-700 text-rose-200 hover:border-rose-400 hover:text-rose-100"
              onclick="deleteItem('/api/movies/<%= m._id %>')">
              Delete
            </button>
          </div>
        </article>
      <% }) %>
    </div>
  </div>

  <div class="space-y-3">
    <h2 class="text-lg font-semibold">Upcoming Screenings</h2>
    <div class="space-y-2">
      <% if (screenings.length === 0) { %>
        <p class="text-slate-400">No screenings yet.</p>
      <% } %>
      <% screenings.forEach(s => { %>
        <div class="bg-slate-900 border border-slate-800 rounded p-3 flex justify-between items-center">
          <div>
            <p class="font-semibold"><%= s.movie ? s.movie.title : '' %></p>
            <p class="text-sm text-slate-300"><%= s.theatre ? s.theatre.name : '' %> - <%= s.theatre && s.theatre.location ? s.theatre.location : '' %></p>
            <p class="text-xs text-slate-400">Start: <%= new Date(s.startTime).toLocaleString() %> | Price: <%= s.price %> | Seats: <%= s.seatsAvailable %></p>
          </div>
          <div class="flex space-x-2">
            <button class="px-3 py-1 text-xs rounded border border-slate-700 hover:border-emerald-400 hover:text-emerald-300"
              data-id="<%= s._id %>"
              data-start="<%= s.startTime.toISOString() %>"
              data-price="<%= s.price %>"
              data-seats="<%= s.seatsAvailable %>"
              onclick="editScreening(this.dataset.id, this.dataset.start, Number(this.dataset.price), Number(this.dataset.seats))">
              Edit
            </button>
            <button class="px-3 py-1 text-xs rounded border border-rose-700 text-rose-200 hover:border-rose-400 hover:text-rose-100"
              onclick="deleteItem('/api/screenings/<%= s._id %>')">
              Delete
            </button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <div class="space-y-3">
    <h2 class="text-lg font-semibold">Theatres</h2>
    <div class="space-y-2">
      <% if (theatres.length === 0) { %>
        <p class="text-slate-400">No theatres yet.</p>
      <% } %>
      <% theatres.forEach(t => { %>
        <div class="bg-slate-900 border border-slate-800 rounded p-3 flex justify-between items-center">
          <div>
            <p class="font-semibold"><%= t.name %></p>
            <p class="text-sm text-slate-300"><%= t.location %></p>
            <p class="text-xs text-slate-400">Screens: <%= t.screens || 1 %></p>
          </div>
          <div class="flex space-x-2">
            <button class="px-3 py-1 text-xs rounded border border-slate-700 hover:border-emerald-400 hover:text-emerald-300"
              data-id="<%= t._id %>"
              data-name="<%- (t.name || '').replace(/"/g, '&quot;') %>"
              data-location="<%- (t.location || '').replace(/"/g, '&quot;') %>"
              data-screens="<%= t.screens || 1 %>"
              onclick="editTheatre(this.dataset.id, this.dataset.name, this.dataset.location, Number(this.dataset.screens))">
              Edit
            </button>
            <button class="px-3 py-1 text-xs rounded border border-rose-700 text-rose-200 hover:border-rose-400 hover:text-rose-100"
              onclick="deleteItem('/api/theatres/<%= t._id %>')">
              Delete
            </button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <div class="space-y-3">
    <h2 class="text-lg font-semibold">Movie ratings</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
      <% movies.forEach(function(m) { %>
        <% var stat = (reviewStatsMap && reviewStatsMap[m._id.toString()]) || null; %>
        <div class="bg-slate-900 border border-slate-800 rounded p-3">
          <div class="flex items-center justify-between">
            <p class="font-semibold"><%= m.title %></p>
            <span class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-300"><%= m.status %></span>
          </div>
          <p class="text-sm text-slate-300">Avg: <%= stat ? (Math.round(stat.avgRating * 10) / 10) : 'N/A' %> (<%= stat ? stat.count : 0 %> reviews)</p>
        </div>
      <% }) %>
    </div>
  </div>

  <div class="space-y-3">
    <h2 class="text-lg font-semibold">Users</h2>
    <div class="overflow-x-auto bg-slate-900 border border-slate-800 rounded">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-800 text-slate-200">
          <tr>
            <th class="text-left px-3 py-2">Name</th>
            <th class="text-left px-3 py-2">Email</th>
            <th class="text-left px-3 py-2">Role</th>
            <th class="text-left px-3 py-2">Joined</th>
          </tr>
        </thead>
        <tbody>
          <% if (!users || !users.length) { %>
            <tr><td class="px-3 py-2 text-slate-400" colspan="4">No users</td></tr>
          <% } %>
          <% users.forEach(u => { %>
            <tr class="border-t border-slate-800">
              <td class="px-3 py-2 text-slate-100"><%= u.name %></td>
              <td class="px-3 py-2 text-slate-300"><%= u.email %></td>
              <td class="px-3 py-2 text-slate-300"><%= u.role %></td>
              <td class="px-3 py-2 text-slate-400"><%= new Date(u.createdAt).toLocaleDateString() %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="space-y-3">
    <h2 class="text-lg font-semibold">Recent reviews</h2>
    <div class="space-y-2">
      <% if (!reviews || !reviews.length) { %>
        <p class="text-slate-400">No reviews yet.</p>
      <% } else { %>
        <% reviews.slice(0, 12).forEach(r => { %>
          <div class="bg-slate-900 border border-slate-800 rounded p-3 space-y-1">
            <div class="flex items-center justify-between text-sm">
              <span class="text-emerald-200 font-semibold"><%= r.user && r.user.name ? r.user.name : 'User' %></span>
              <span class="text-amber-300">â˜… <%= r.rating %></span>
            </div>
            <p class="text-sm text-slate-200"><%= r.movie ? r.movie.title : '' %></p>
            <% if (r.comment) { %><p class="text-sm text-slate-300"><%= r.comment %></p><% } %>
            <p class="text-xs text-slate-500"><%= new Date(r.createdAt).toLocaleString() %></p>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</section>

<script>
  const handleSubmit = (formId, url, successElId, mapper) => {
    const form = document.getElementById(formId);
    const msg = document.getElementById(successElId);
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.classList.add('hidden');
      const payload = mapper(new FormData(form));
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Request failed');
        msg.textContent = 'Saved!';
        msg.classList.remove('hidden');
        setTimeout(() => window.location.reload(), 600);
      } catch (err) {
        msg.textContent = err.message;
        msg.classList.remove('hidden');
        msg.classList.remove('text-emerald-300');
        msg.classList.add('text-rose-300');
      }
    });
  };

  handleSubmit('movieForm', '/api/movies', 'movieMsg', (fd) => ({
    title: fd.get('title'),
    description: fd.get('description'),
    posterUrl: fd.get('posterUrl'),
    durationMins: fd.get('durationMins') ? Number(fd.get('durationMins')) : undefined,
    genres: fd.get('genres') ? fd.get('genres').split(',').map(g => g.trim()).filter(Boolean) : [],
    status: fd.get('status')
  }));

  handleSubmit('screeningForm', '/api/screenings', 'screeningMsg', (fd) => ({
    movie: fd.get('movie'),
    theatre: fd.get('theatre'),
    startTime: fd.get('startTime'),
    price: Number(fd.get('price')),
    seatsAvailable: Number(fd.get('seatsAvailable')),
    screen: fd.get('screen') ? Number(fd.get('screen')) : undefined
  }));

  handleSubmit('theatreForm', '/api/theatres', 'theatreMsg', (fd) => ({
    name: fd.get('name'),
    location: fd.get('location'),
    screens: fd.get('screens') ? Number(fd.get('screens')) : undefined
  }));

  const deleteItem = async (url) => {
    if (!confirm('Are you sure you want to delete this item?')) return;
    const res = await fetch(url, { method: 'DELETE', credentials: 'same-origin' });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      alert(data.message || 'Delete failed');
      return;
    }
    window.location.reload();
  };

  const editMovie = async (id, title, status, duration) => {
    const newTitle = prompt('Title', title);
    if (newTitle === null) return;
    const newStatus = prompt('Status (now_showing|coming_soon)', status);
    if (newStatus === null) return;
    const newDuration = prompt('Duration minutes', duration || '');
    const payload = {
      title: newTitle.trim(),
      status: newStatus.trim(),
      durationMins: newDuration ? Number(newDuration) : undefined
    };
    const res = await fetch(`/api/movies/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      alert(data.message || 'Update failed');
      return;
    }
    window.location.reload();
  };

  const editTheatre = async (id, name, location, screens) => {
    const newName = prompt('Name', name);
    if (newName === null) return;
    const newLocation = prompt('Location', location);
    if (newLocation === null) return;
    const newScreens = prompt('Number of screens', screens || '');
    const payload = {
      name: newName.trim(),
      location: newLocation.trim(),
      screens: newScreens ? Number(newScreens) : undefined
    };
    const res = await fetch(`/api/theatres/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      alert(data.message || 'Update failed');
      return;
    }
    window.location.reload();
  };

  const editScreening = async (id, startIso, price, seatsAvailable) => {
    const newStart = prompt('Start time (YYYY-MM-DDTHH:MM)', startIso.slice(0,16));
    if (newStart === null) return;
    const newPrice = prompt('Price', price);
    if (newPrice === null) return;
    const newSeats = prompt('Seats available', seatsAvailable);
    if (newSeats === null) return;
    const payload = {
      startTime: newStart,
      price: Number(newPrice),
      seatsAvailable: Number(newSeats)
    };
    const res = await fetch(`/api/screenings/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      alert(data.message || 'Update failed');
      return;
    }
    window.location.reload();
  };
</script>
<%- include('../partials/footer') %>

