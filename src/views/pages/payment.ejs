<%- include('../partials/header', { title, user }) %>
<section class="space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <p class="text-sm uppercase tracking-wide text-emerald-300">Payment</p>
      <h1 class="text-2xl font-semibold">Complete your booking</h1>
      <p class="text-sm text-slate-400">Review seats and pay to confirm, like on BookMyShow.</p>
    </div>
  </div>

  <% if (!user) { %>
    <div class="bg-amber-900/40 border border-amber-700 text-amber-100 rounded p-3 text-sm">
      Please <a href="/login" class="text-emerald-300 hover:text-emerald-200">log in</a> to proceed with payment.
    </div>
  <% } %>

  <div class="grid md:grid-cols-3 gap-4">
    <div class="md:col-span-2 space-y-4">
      <div class="bg-slate-900 border border-slate-800 rounded p-4 shadow shadow-emerald-900/30 space-y-2">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-400"><%= screening.theatre?.name %> <%= screening.theatre?.location ? ' - ' + screening.theatre.location : '' %></p>
            <p class="text-lg font-semibold text-emerald-200"><%= screening.movie?.title || 'Movie' %></p>
            <p class="text-sm text-slate-400"><%= new Date(screening.startTime).toLocaleString() %></p>
          </div>
          <span class="text-xs text-slate-400">Screen <%= screening.screen || 1 %></span>
        </div>
        <div class="text-sm text-slate-300">Seats: <span class="text-emerald-300"><%= seats.join(', ') %></span></div>
      </div>

      <div class="bg-slate-900 border border-slate-800 rounded p-4 space-y-3">
        <h3 class="font-semibold text-emerald-200">Payment details</h3>
        <form id="paymentForm" class="space-y-3">
          <div class="grid sm:grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-sm text-slate-300">Card holder</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="Name on card" required />
            </div>
            <div class="space-y-1">
              <label class="text-sm text-slate-300">Email</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="you@example.com" type="email" required />
            </div>
          </div>
          <div class="space-y-1">
            <label class="text-sm text-slate-300">Card number</label>
            <input class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="4242 4242 4242 4242" required />
          </div>
          <div class="grid sm:grid-cols-3 gap-3">
            <div class="space-y-1">
              <label class="text-sm text-slate-300">Expiry</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="MM/YY" required />
            </div>
            <div class="space-y-1">
              <label class="text-sm text-slate-300">CVV</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="123" required />
            </div>
            <div class="space-y-1">
              <label class="text-sm text-slate-300">Zip</label>
              <input class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="000000" required />
            </div>
          </div>

          <input type="hidden" id="screeningId" value="<%= screening._id %>" />
          <input type="hidden" id="seatsCsv" value="<%= seats.join(',') %>" />
          <div id="payMsg" class="text-sm text-emerald-300 hidden"></div>
          <button
            type="submit"
            class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
            <%= user ? '' : 'disabled' %>
          >
            Pay &amp; Book
          </button>
        </form>
      </div>
    </div>

    <div class="bg-slate-900 border border-slate-800 rounded p-4 space-y-3 h-fit shadow shadow-emerald-900/30">
      <h3 class="font-semibold text-emerald-200">Fare summary</h3>
      <div class="flex items-center justify-between text-sm text-slate-300">
        <span>Tickets (<%= seats.length %> x <%= screening.price %>)</span>
        <span><%= seats.length * screening.price %></span>
      </div>
      <div class="flex items-center justify-between text-sm text-slate-300">
        <span>Convenience fee</span>
        <span>0</span>
      </div>
      <div class="border-t border-slate-800 pt-2 flex items-center justify-between text-sm font-semibold text-emerald-200">
        <span>Total</span>
        <span><%= total %></span>
      </div>
      <p class="text-xs text-slate-500">Secure payment simulation only. No real charges.</p>
    </div>
  </div>
</section>
<script>
  const paymentForm = document.getElementById('paymentForm');
  const payMsg = document.getElementById('payMsg');
  const screeningId = document.getElementById('screeningId')?.value;
  const seatsCsv = document.getElementById('seatsCsv')?.value;

  if (paymentForm) {
    paymentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      payMsg.classList.add('hidden');
      payMsg.classList.remove('text-rose-300');
      payMsg.classList.add('text-emerald-300');
      try {
        const seats = (seatsCsv || '')
          .split(',')
          .map((s) => s.trim())
          .filter(Boolean);
        const res = await fetch('/api/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ screeningId, seats })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Payment failed');
        payMsg.textContent = 'Booking confirmed! Fetching ticket...';
        payMsg.classList.remove('hidden');
        paymentForm.querySelector('button[type="submit"]').disabled = true;
        if (data.booking && data.booking._id) {
          setTimeout(() => { window.location.href = `/ticket/${data.booking._id}`; }, 800);
        } else {
          setTimeout(() => { window.location.href = '/'; }, 800);
        }
      } catch (err) {
        payMsg.textContent = err.message;
        payMsg.classList.remove('hidden');
        payMsg.classList.remove('text-emerald-300');
        payMsg.classList.add('text-rose-300');
      }
    });
  }
</script>
<%- include('../partials/footer') %>

