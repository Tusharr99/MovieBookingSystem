<%- include('../partials/header', { title, user }) %>
<section class="space-y-8">
  <div class="grid lg:grid-cols-2 gap-6 items-start">
    <div class="bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 rounded-lg p-4 shadow shadow-emerald-900/40">
      <% if (movie.posterUrl) { %>
        <img src="<%= movie.posterUrl %>" alt="<%= movie.title %>" class="w-full rounded-lg object-cover max-h-[500px]" />
      <% } else { %>
        <div class="aspect-[2/3] w-full rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400">
          No poster
        </div>
      <% } %>
      <div class="flex items-center justify-between mt-4">
        <div class="text-xs text-slate-400">In cinemas</div>
        <a href="<%= movie.trailerUrl || '#' %>" class="text-sm text-emerald-300 hover:text-emerald-200">Trailers</a>
      </div>
    </div>

    <div class="space-y-4">
      <div class="space-y-2">
        <h1 class="text-3xl font-semibold"><%= movie.title %></h1>
        <div class="flex flex-wrap gap-2 text-sm text-slate-300">
          <span><%= movie.durationMins ? movie.durationMins + ' mins' : 'TBD' %></span>
          <span>•</span>
          <span><%= (movie.genres || []).join(', ') || 'Genre TBD' %></span>
          <span>•</span>
          <span class="px-2 py-1 rounded-full bg-emerald-900/40 text-emerald-300">
            <%= movie.status === 'coming_soon' ? 'Coming Soon' : 'Now Showing' %>
          </span>
        </div>
      </div>

      <p class="text-slate-200 leading-relaxed"><%= movie.description || 'No description yet.' %></p>

      <div class="flex items-center gap-3">
        <a
          href="<%= screenings.length ? '/book/' + movie._id : '#' %>"
          class="inline-flex items-center justify-center px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold disabled:opacity-50"
          <%= screenings.length ? '' : 'aria-disabled="true" tabindex="-1"' %>
        >
          Book tickets
        </a>
        <span class="text-sm text-slate-400"><%= screenings.length ? 'Select timing below' : 'No shows yet' %></span>
      </div>

      <div class="space-y-3">
        <h3 class="text-lg font-semibold text-emerald-200">Showtimes</h3>
        <% if (!screenings.length) { %>
          <p class="text-slate-400 text-sm">No screenings scheduled yet.</p>
        <% } else { %>
          <div class="space-y-3">
            <% screenings.forEach(s => { %>
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 bg-slate-900 border border-slate-800 rounded p-3">
                <div>
                  <p class="font-semibold"><%= s.theatre?.name %></p>
                  <p class="text-xs text-slate-400"><%= s.theatre?.location %></p>
                </div>
                <div class="flex items-center gap-2">
                  <span class="px-3 py-1 rounded border border-slate-700 text-sm text-emerald-200">
                    <%= new Date(s.startTime).toLocaleString() %>
                  </span>
                  <a
                    class="px-3 py-1 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-950 text-sm font-semibold"
                    href="/book/<%= movie._id %>#seatmap"
                    data-screening="<%= s._id %>"
                  >
                    Select seats
                  </a>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>

      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-emerald-200">Reviews</h3>
          <span class="text-sm text-slate-300">Avg rating: <%= avgRating || 0 %> (<%= reviews.length %>)</span>
        </div>

        <% if (user) { %>
          <form id="reviewForm" class="bg-slate-900 border border-slate-800 rounded p-3 space-y-3">
            <div class="flex items-center gap-3 text-sm">
              <label class="text-slate-300">Your rating</label>
              <div id="ratingStars" class="flex items-center gap-1">
                <% for (let i = 1; i <= 5; i++) { %>
                  <button type="button" data-rate="<%= i %>" class="star-btn text-lg text-slate-500 hover:text-emerald-300">★</button>
                <% } %>
              </div>
              <input type="hidden" name="rating" id="ratingInput" required />
            </div>
            <div class="space-y-1">
              <label class="text-sm text-slate-300">Review</label>
              <textarea name="comment" id="comment" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm" placeholder="Share your thoughts"></textarea>
            </div>
            <div id="reviewMsg" class="text-sm text-emerald-300 hidden"></div>
            <button type="submit" class="px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold text-sm">
              Submit review
            </button>
          </form>
        <% } else { %>
          <div class="bg-slate-900 border border-slate-800 rounded p-3 text-sm text-slate-300">
            Please <a href="/login" class="text-emerald-300 hover:text-emerald-200">log in</a> to leave a review.
          </div>
        <% } %>

        <div class="space-y-2">
          <% if (!reviews.length) { %>
            <p class="text-slate-400 text-sm">No reviews yet. Be the first to review.</p>
          <% } else { %>
            <% reviews.forEach(r => { %>
              <div class="bg-slate-900 border border-slate-800 rounded p-3 space-y-1">
                <div class="flex items-center justify-between text-sm">
                  <span class="text-emerald-200 font-semibold"><%= r.user?.name || 'User' %></span>
                  <span class="text-amber-300">★ <%= r.rating %></span>
                </div>
                <% if (r.comment) { %>
                  <p class="text-slate-200 text-sm"><%= r.comment %></p>
                <% } %>
                <p class="text-xs text-slate-500"><%= new Date(r.createdAt).toLocaleString() %></p>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
  const ratingInput = document.getElementById('ratingInput');
  const reviewForm = document.getElementById('reviewForm');
  const reviewMsg = document.getElementById('reviewMsg');
  const stars = Array.from(document.querySelectorAll('.star-btn'));

  const setStars = (value) => {
    stars.forEach((s) => {
      const v = Number(s.dataset.rate);
      s.classList.toggle('text-emerald-300', v <= value);
      s.classList.toggle('text-slate-500', v > value);
    });
  };

  stars.forEach((btn) => {
    btn.addEventListener('click', () => {
      const val = Number(btn.dataset.rate);
      ratingInput.value = val;
      setStars(val);
    });
  });

  if (reviewForm) {
    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      reviewMsg.classList.add('hidden');
      reviewMsg.classList.remove('text-rose-300');
      reviewMsg.classList.add('text-emerald-300');
      const rating = Number(ratingInput.value);
      const comment = document.getElementById('comment').value;
      if (!rating) {
        reviewMsg.textContent = 'Select a rating first.';
        reviewMsg.classList.remove('hidden');
        reviewMsg.classList.add('text-rose-300');
        return;
      }
      try {
        const res = await fetch('/api/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ movie: '<%= movie._id %>', rating, comment })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Review failed');
        reviewMsg.textContent = data.updated ? 'Review updated' : 'Review added';
        reviewMsg.classList.remove('hidden');
        reviewForm.reset();
        ratingInput.value = '';
        setStars(0);
        setTimeout(() => window.location.reload(), 700);
      } catch (err) {
        reviewMsg.textContent = err.message;
        reviewMsg.classList.remove('hidden');
        reviewMsg.classList.remove('text-emerald-300');
        reviewMsg.classList.add('text-rose-300');
      }
    });
  }
</script>
<%- include('../partials/footer') %>

